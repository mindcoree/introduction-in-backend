{% extends 'base.html' %}
{% block title %}Posts{% endblock %}
{% block content %}
    <h1 class="text-3xl font-bold mb-6">All Posts</h1>
    <div class="mb-6 flex flex-col md:flex-row md:items-center md:space-x-4">
        <input type="text" id="search-input" placeholder="Search by title..." class="border p-3 rounded-lg w-full md:w-1/2 focus:outline-none focus:ring-2 focus:ring-blue-500" value="{{ search_query }}">
        {% if user.is_authenticated %}
            <label class="flex items-center mt-2 md:mt-0">
                <input type="checkbox" id="my-posts" {% if my_posts %}checked{% endif %} class="mr-2">
                <span class="text-gray-700">Show only my posts</span>
            </label>
        {% endif %}
    </div>
    <div id="post-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% if posts %}
            {% for post in posts %}
                <div class="bg-white p-4 rounded-lg shadow hover:shadow-lg">
                    <h2 class="text-xl font-semibold"><a href="{% url 'post_detail' post.id %}" class="text-blue-600 hover:underline">{{ post.title }}</a></h2>
                    <p class="text-gray-600 mt-2">{{ post.content|truncatewords:30 }}</p>
                    <p class="text-sm text-gray-500 mt-2">By {{ post.author.username }} on {{ post.created_at|date:"F d, Y" }}</p>
                    {% if user.is_authenticated and user == post.author %}
                        <div class="mt-4 space-x-2">
                            <a href="{% url 'post_edit' post.id %}" class="text-blue-500 hover:underline">Edit</a>
                            <form method="POST" action="{% url 'post_delete' post.id %}" class="inline delete-post-form" data-post-id="{{ post.id }}">
                                {% csrf_token %}
                                <button type="submit" class="text-red-500 hover:underline" onclick="return confirm('Are you sure you want to delete this post?')">Delete</button>
                            </form>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <p class="text-gray-600">No posts found.</p>
        {% endif %}
    </div>

    <!-- Pagination controls -->
    {% if page_obj %}
        <div class="mt-6 flex justify-center space-x-2">
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if my_posts %}&my_posts=true{% endif %}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Previous</a>
            {% endif %}
            {% for num in page_obj.paginator.page_range %}
                {% if num == page_obj.number %}
                    <span class="bg-blue-600 text-white px-4 py-2 rounded">{{ num }}</span>
                {% else %}
                    <a href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if my_posts %}&my_posts=true{% endif %}" class="bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300">{{ num }}</a>
                {% endif %}
            {% endfor %}
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if my_posts %}&my_posts=true{% endif %}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Next</a>
            {% endif %}
        </div>
    {% endif %}

    <script>
        function getCurrentPage() {
            const urlParams = new URLSearchParams(window.location.search);
            return parseInt(urlParams.get('page')) || 1;
        }

        function performSearch(page = getCurrentPage()) {
            const query = document.getElementById('search-input').value.trim();
            const myPosts = document.getElementById('my-posts') ? document.getElementById('my-posts').checked : false;
            const url = `/search/?search=${encodeURIComponent(query)}&my_posts=${myPosts}&page=${page}`;

            console.log('Performing search with URL:', url); // Отладка

            fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Received data:', data); // Отладка
                const postList = document.getElementById('post-list');
                postList.innerHTML = '';
                if (data.posts.length > 0) {
                    data.posts.forEach(post => {
                        const postDiv = document.createElement('div');
                        postDiv.className = 'bg-white p-4 rounded-lg shadow hover:shadow-lg';
                        postDiv.innerHTML = `
                            <h2 class="text-xl font-semibold">
                                <a href="/posts/${post.id}/" class="text-blue-600 hover:underline">${post.title}</a>
                            </h2>
                            <p class="text-gray-600 mt-2">${post.content.substring(0, 100)}...</p>
                            <p class="text-sm text-gray-500 mt-2">By ${post.author} on ${post.created_at}</p>
                            ${post.is_author ? `
                                <div class="mt-4 space-x-2">
                                    <a href="/posts/${post.id}/edit/" class="text-blue-500 hover:underline">Edit</a>
                                    <form method="POST" action="/posts/${post.id}/delete/" class="inline delete-post-form" data-post-id="${post.id}">
                                        <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]').value}">
                                        <button type="submit" class="text-red-500 hover:underline" onclick="return confirm('Are you sure you want to delete this post?')">Delete</button>
                                    </form>
                                </div>
                            ` : ''}
                        `;
                        postList.appendChild(postDiv);
                    });
                } else {
                    postList.innerHTML = '<p class="text-gray-600">No posts found.</p>';
                    // Проверяем, есть ли посты на других страницах
                    if (data.total_pages > 0 && page > data.total_pages) {
                        console.log(`Page ${page} is empty, redirecting to last page: ${data.total_pages}`);
                        performSearch(data.total_pages); // Перейти на последнюю страницу
                        return;
                    }
                }

                // Update pagination controls
                const paginationDiv = document.createElement('div');
                paginationDiv.className = 'mt-6 flex justify-center space-x-2';
                if (data.has_previous) {
                    const prevLink = document.createElement('a');
                    prevLink.href = '#';
                    prevLink.className = 'bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700';
                    prevLink.textContent = 'Previous';
                    prevLink.onclick = () => { performSearch(data.previous_page); return false; };
                    paginationDiv.appendChild(prevLink);
                }
                for (let i = 1; i <= data.total_pages; i++) {
                    const pageLink = document.createElement(i === data.current_page ? 'span' : 'a');
                    pageLink.className = i === data.current_page ? 'bg-blue-600 text-white px-4 py-2 rounded' : 'bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300';
                    pageLink.textContent = i;
                    if (i !== data.current_page) {
                        pageLink.href = '#';
                        pageLink.onclick = () => { performSearch(i); return false; };
                    }
                    paginationDiv.appendChild(pageLink);
                }
                if (data.has_next) {
                    const nextLink = document.createElement('a');
                    nextLink.href = '#';
                    nextLink.className = 'bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700';
                    nextLink.textContent = 'Next';
                    nextLink.onclick = () => { performSearch(data.next_page); return false; };
                    paginationDiv.appendChild(nextLink);
                }
                const existingPagination = document.querySelector('.mt-6.flex.justify-center');
                if (existingPagination) {
                    existingPagination.replaceWith(paginationDiv);
                } else {
                    postList.insertAdjacentElement('afterend', paginationDiv);
                }

                // Update URL to reflect current search and page
                const newUrl = `/?search=${encodeURIComponent(query)}&my_posts=${myPosts}&page=${data.current_page}`;
                window.history.pushState({}, '', newUrl);
            })
            .catch(error => console.error('Error during search:', error));
        }

        document.getElementById('search-input').addEventListener('input', function() {
            if (this.value.trim().length >= 2 || this.value.trim().length === 0) {
                performSearch();
            }
        });

        document.getElementById('my-posts')?.addEventListener('change', () => performSearch());

        // Handle delete form submissions
        document.addEventListener('submit', function(event) {
            if (event.target.classList.contains('delete-post-form')) {
                event.preventDefault();
                const postId = event.target.dataset.postId;
                if (confirm('Are you sure you want to delete this post?')) {
                    fetch(event.target.action, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            console.log(`Post ${postId} deleted successfully`);
                            // После удаления пытаемся загрузить текущую страницу
                            const currentPage = getCurrentPage();
                            performSearch(currentPage);
                        } else {
                            console.error('Failed to delete post:', response.status);
                            alert('Failed to delete post.');
                        }
                    })
                    .catch(error => {
                        console.error('Error during deletion:', error);
                        alert('Error deleting post.');
                    });
                }
            }
        });
    </script>
{% endblock %}